<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Console · Inbox</title>
    <style>
      :root {
        --fg: #0f172a;
        --muted: #475569;
        --accent: #2563eb;
        --bg: #f8fafc;
        --card: #fff;
        --border: #e2e8f0;
        --danger: #ef4444;
        --success: #16a34a;
      }
      * { box-sizing: border-box; }
      body { margin: 0; font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; color: var(--fg); background: var(--bg); }
      header { position: sticky; top: 0; z-index: 5; background: var(--card); padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
      header h1 { margin: 0; font-size: 16px; }
      header .meta { color: var(--muted); font-size: 12px; }
      .chip { padding: 4px 8px; border-radius: 999px; background: #e2e8f0; color: #0f172a; font-size: 11px; text-transform: uppercase; letter-spacing: 0.02em; }
      .wrap { display: grid; grid-template-columns: 2fr 3fr; gap: 12px; padding: 12px; height: calc(100vh - 70px); }
      .column-grid { display: grid; grid-template-columns: repeat(4, minmax(200px, 1fr)); gap: 10px; align-content: start; }
      .col { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; min-height: 200px; display: flex; flex-direction: column; }
      .col h2 { margin: 0 0 8px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); display: flex; justify-content: space-between; align-items: center; }
      .ticket { border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-bottom: 8px; background: #fff; cursor: pointer; display: grid; gap: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
      .ticket:hover { border-color: var(--accent); }
      .ticket .id { font-weight: 600; font-size: 13px; }
      .ticket .meta { color: var(--muted); font-size: 12px; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
      .ticket .tag { background: #eef2ff; color: #312e81; padding: 2px 6px; border-radius: 6px; font-size: 11px; }
      .ticket .message { color: var(--fg); font-size: 13px; }
      .panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; display: flex; flex-direction: column; height: 100%; }
      .panel .section { padding: 12px 14px; border-bottom: 1px solid var(--border); }
      .panel h3 { margin: 0 0 6px; font-size: 14px; }
      .panel .stack { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .transcript { flex: 1; overflow: auto; padding: 12px 14px; }
      .msg { margin-bottom: 10px; display: grid; gap: 4px; }
      .msg .who { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
      .bubble { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
      .composer { padding: 12px 14px; border-top: 1px solid var(--border); display: grid; gap: 8px; }
      textarea, input[type="text"], input[type="search"] { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); font: inherit; }
      button { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-weight: 600; }
      button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
      button.ghost { background: transparent; }
      button.danger { background: var(--danger); color: #fff; border-color: var(--danger); }
      .note-list { max-height: 180px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: #f8fafc; display: grid; gap: 6px; }
      .note { font-size: 13px; }
      .note .meta { color: var(--muted); font-size: 11px; }
      .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .pill { padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; background: #f1f5f9; font-size: 12px; }
      .status-new { border-left: 3px solid #2563eb; }
      .status-assigned { border-left: 3px solid #16a34a; }
      .status-snoozed { border-left: 3px solid #f59e0b; }
      .status-closed { border-left: 3px solid #475569; }
      .macro { padding: 6px 8px; border: 1px dashed var(--border); border-radius: 8px; cursor: pointer; }
      .macro:hover { border-color: var(--accent); }
      .inline-input { width: auto; min-width: 140px; }
      .badge { background: #0ea5e9; color: #fff; padding: 2px 6px; border-radius: 6px; font-size: 11px; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Agent Console</h1>
        <div class="meta">Monitor queue status, assignments, transcripts, and automation assist.</div>
      </div>
      <div class="toolbar" style="margin-left:auto;">
        <label>Agent ID <input id="agentId" class="inline-input" type="text" /></label>
        <button id="subscribe" class="primary">Subscribe</button>
        <span id="wsStatus" class="pill">WS: idle</span>
      </div>
    </header>
    <div class="wrap">
      <div class="column-grid" id="columns"></div>
      <div class="panel">
        <div class="section">
          <div class="toolbar">
            <div>
              <h3 id="selectedTitle" style="margin:0;">No ticket selected</h3>
              <div id="selectedMeta" class="meta"></div>
            </div>
            <button id="refresh" class="ghost">Refresh</button>
          </div>
        </div>
        <div class="transcript" id="transcript"></div>
        <div class="section" style="border-top:1px solid var(--border);">
          <div class="toolbar">
            <button id="assignMe">Assign to me</button>
            <button id="snooze">Snooze</button>
            <button id="close">Close</button>
            <button id="reopen">Re-open</button>
            <input id="manualAssignee" type="text" class="inline-input" placeholder="Assign to..." />
            <button id="assignManual">Assign</button>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <input id="tagsInput" type="text" class="inline-input" placeholder="Tags (csv)" />
            <button id="saveTags">Save tags</button>
            <input id="roundRobinAgents" type="text" class="inline-input" placeholder="Round robin agents csv" />
            <button id="roundRobin">Round robin assign</button>
          </div>
        </div>
        <div class="composer">
          <label style="display:block; font-weight:600;">Reply draft</label>
          <textarea id="replyText" rows="3" placeholder="Type reply to user..."></textarea>
          <div class="toolbar">
            <button id="sendReply" class="primary">Send reply</button>
            <button id="draftAssist">AI Draft reply</button>
            <button id="addNote">Add note</button>
          </div>
          <div class="toolbar" id="macros"></div>
          <div id="notes" class="note-list"></div>
        </div>
      </div>
    </div>
    <script>
      const columnsEl = document.getElementById('columns');
      const selectedTitle = document.getElementById('selectedTitle');
      const selectedMeta = document.getElementById('selectedMeta');
      const transcriptEl = document.getElementById('transcript');
      const replyText = document.getElementById('replyText');
      const notesEl = document.getElementById('notes');
      const wsStatus = document.getElementById('wsStatus');
      const macrosEl = document.getElementById('macros');
      const agentIdInput = document.getElementById('agentId');
      const state = { tickets: [], selected: null, messages: {}, notes: {}, agentId: localStorage.getItem('agentId') || 'agent-1' };
      agentIdInput.value = state.agentId;

      const cannedMacros = [
        'Thanks for reaching out! I am reviewing your request now.',
        'Can you share a screenshot and the steps that led to this issue?',
        'I am escalating this to a specialist. We will update you shortly.',
      ];

      function renderMacros() {
        macrosEl.innerHTML = '';
        cannedMacros.forEach((m) => {
          const btn = document.createElement('div');
          btn.className = 'macro';
          btn.textContent = m;
          btn.onclick = () => {
            replyText.value = ((replyText.value || '') + '\n' + m).trim();
          };
          macrosEl.appendChild(btn);
        });
      }

      async function api(path, opts) {
        const res = await fetch(path, { headers: { 'Content-Type': 'application/json' }, ...opts });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      }

      function groupTickets() {
        const buckets = { new: [], assigned: [], snoozed: [], closed: [] };
        for (const t of state.tickets) buckets[t.status]?.push(t);
        return buckets;
      }

      function renderTickets() {
        const grouped = groupTickets();
        const statusOrder = [
          { key: 'new', label: 'New' },
          { key: 'assigned', label: 'Assigned' },
          { key: 'snoozed', label: 'Snoozed' },
          { key: 'closed', label: 'Closed' },
        ];
        columnsEl.innerHTML = '';
        statusOrder.forEach((col) => {
          const wrap = document.createElement('div');
          wrap.className = 'col';
          wrap.innerHTML = `<h2>${col.label} <span class="badge">${grouped[col.key].length}</span></h2>`;
          const list = document.createElement('div');
          grouped[col.key].forEach((t) => {
            const card = document.createElement('div');
            card.className = `ticket status-${t.status}`;
            card.innerHTML = `
              <div class="id">${t.sessionId}</div>
              <div class="meta">
                ${t.assignedAgentId ? `<span class="pill">${t.assignedAgentId}</span>` : '<span class="pill">Unassigned</span>'}
                ${t.tags?.map((tag) => `<span class="tag">${tag}</span>`).join('') || ''}
              </div>
              <div class="message">${(t.lastMessage || '').slice(0, 120)}</div>
            `;
            card.onclick = () => selectTicket(t.id);
            list.appendChild(card);
          });
          if (!grouped[col.key].length) {
            const empty = document.createElement('div');
            empty.className = 'meta';
            empty.textContent = 'Empty';
            list.appendChild(empty);
          }
          wrap.appendChild(list);
          columnsEl.appendChild(wrap);
        });
      }

      async function loadInbox() {
        const params = new URLSearchParams({ includeNotes: 'true' });
        const data = await api('/api/admin/inbox?' + params.toString());
        state.tickets = data || [];
        renderTickets();
        if (state.selected) refreshSelection();
      }

      async function refreshSelection() {
        const ticket = state.tickets.find((t) => t.id === state.selected);
        if (!ticket) {
          selectedTitle.textContent = 'No ticket selected';
          transcriptEl.innerHTML = '<div class="meta">Select a ticket to view transcripts.</div>';
          notesEl.innerHTML = '';
          return;
        }
        selectedTitle.textContent = `Ticket ${ticket.sessionId}`;
        selectedMeta.textContent = `Status: ${ticket.status.toUpperCase()} • Agent: ${ticket.assignedAgentId || 'Unassigned'} • Tags: ${(ticket.tags || []).join(', ') || 'none'}`;
        document.getElementById('tagsInput').value = (ticket.tags || []).join(',');
        await loadTranscript(ticket);
        renderNotes(ticket);
      }

      async function loadTranscript(ticket) {
        const msgs = await api('/api/admin/messages?sessionId=' + encodeURIComponent(ticket.sessionId));
        state.messages[ticket.id] = msgs;
        transcriptEl.innerHTML = '';
        msgs.forEach((m) => {
          const row = document.createElement('div');
          row.className = 'msg';
          row.innerHTML = `<div class="who">${m.sender} · ${new Date(m.createdAt).toLocaleString()}</div><div class="bubble">${m.text}</div>`;
          transcriptEl.appendChild(row);
        });
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
      }

      function renderNotes(ticket) {
        notesEl.innerHTML = '';
        (ticket.notes || []).forEach((n) => {
          const row = document.createElement('div');
          row.className = 'note';
          row.innerHTML = `<div class="meta">${n.authorId || 'agent'} · ${new Date(n.createdAt).toLocaleString()}</div><div>${n.text}</div>`;
          notesEl.appendChild(row);
        });
        if (!notesEl.innerHTML) notesEl.innerHTML = '<div class="meta">No notes yet.</div>';
      }

      async function selectTicket(id) {
        state.selected = id;
        await refreshSelection();
      }

      async function sendAction(action, payload) {
        await api('/api/admin/inbox', { method: 'POST', body: JSON.stringify({ action, ...payload }) });
        await loadInbox();
      }

      document.getElementById('refresh').onclick = loadInbox;
      document.getElementById('assignMe').onclick = () => {
        if (!state.selected) return;
        sendAction('assign', { ticketId: state.selected, agentId: state.agentId });
      };
      document.getElementById('assignManual').onclick = () => {
        if (!state.selected) return;
        const agent = document.getElementById('manualAssignee').value.trim();
        if (!agent) return;
        sendAction('assign', { ticketId: state.selected, agentId: agent });
      };
      document.getElementById('snooze').onclick = () => state.selected && sendAction('status', { ticketId: state.selected, status: 'snoozed' });
      document.getElementById('close').onclick = () => state.selected && sendAction('status', { ticketId: state.selected, status: 'closed' });
      document.getElementById('reopen').onclick = () => state.selected && sendAction('status', { ticketId: state.selected, status: 'assigned' });
      document.getElementById('roundRobin').onclick = () => {
        if (!state.selected) return;
        const agents = (document.getElementById('roundRobinAgents').value || '')
          .split(',')
          .map((s) => s.trim())
          .filter(Boolean);
        sendAction('roundRobinAssign', { ticketId: state.selected, agents });
      };
      document.getElementById('saveTags').onclick = () => {
        if (!state.selected) return;
        const tags = (document.getElementById('tagsInput').value || '')
          .split(',')
          .map((t) => t.trim())
          .filter(Boolean);
        sendAction('tags', { ticketId: state.selected, tags });
      };

      document.getElementById('sendReply').onclick = async () => {
        if (!state.selected) return;
        const ticket = state.tickets.find((t) => t.id === state.selected);
        const text = replyText.value.trim();
        if (!text) return;
        await api('/api/admin/send', { method: 'POST', body: JSON.stringify({ sessionId: ticket.sessionId, text }) });
        replyText.value = '';
        await loadTranscript(ticket);
      };

      document.getElementById('draftAssist').onclick = async () => {
        if (!state.selected) return;
        const data = await api('/api/admin/inbox/assist', {
          method: 'POST',
          body: JSON.stringify({ ticketId: state.selected, prompt: replyText.value || undefined }),
        });
        replyText.value = data.text || data.reply || '';
      };

      document.getElementById('addNote').onclick = async () => {
        if (!state.selected) return;
        const text = replyText.value.trim();
        if (!text) return;
        await sendAction('note', { ticketId: state.selected, text });
        replyText.value = '';
      };

      function subscribeWs() {
        try {
          if (window._ws) window._ws.close();
        } catch {}
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${proto}://${location.host}${(window.__WS_PATH__ || '/api/chat/ws')}`);
        window._ws = ws;
        wsStatus.textContent = 'WS: connecting';
        ws.onopen = () => {
          wsStatus.textContent = 'WS: connected';
          ws.send(JSON.stringify({ type: 'subscribe', channel: `agent:${state.agentId || 'all'}` }));
          ws.send(JSON.stringify({ type: 'subscribe', channel: 'agent:all' }));
        };
        ws.onclose = () => (wsStatus.textContent = 'WS: closed');
        ws.onerror = () => (wsStatus.textContent = 'WS: error');
        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg.type && msg.type.startsWith('ticket')) {
              loadInbox();
            }
          } catch (e) {
            console.warn('ws parse failed', e);
          }
        };
      }

      document.getElementById('subscribe').onclick = () => {
        state.agentId = agentIdInput.value.trim() || 'agent-1';
        localStorage.setItem('agentId', state.agentId);
        subscribeWs();
      };

      renderMacros();
      loadInbox();
      subscribeWs();
      setInterval(loadInbox, 7000);
    </script>
  </body>
</html>
